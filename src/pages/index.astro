---
import Default from '../layouts/DefaultLayout.astro';
import Hero from '../components/Hero.tsx';

const trajectory = [
  {
    organization: 'Instituto de Desarrollo Agropecuario (INDAP)',
    role: 'Jefe de Comunicación Corporativa',
    period: '2023 – Actualidad',
    link: 'https://www.indap.gob.cl/',
    image: '/images/exp-indap.png',
    alt: 'INDAP',
  },
  {
    organization: 'Ministerio de Educación',
    role: 'Coordinador de Comunicaciones',
    period: '2022 – 2023',
    link: 'https://www.mineduc.cl/',
    image: '/images/exp-mineduc.png',
    alt: 'Ministerio de Educación',
  },
  {
    organization: 'Subsecretaría de Telecomunicaciones',
    role: 'Asesor Comunicacional',
    period: '2021 – 2022',
    link: 'https://www.subtel.gob.cl/',
    image: '/images/exp-subtel.png',
    alt: 'Subsecretaría de Telecomunicaciones',
  },
  {
    organization: 'Municipalidad de Cerro Navia',
    role: 'Asesor Comunicacional',
    period: '2021',
    link: 'https://www.cerronavia.cl/',
    image: '/images/exp-cerro-navia.png',
    alt: 'Municipalidad de Cerro Navia',
  },
  {
    organization: "TVN Red O'Higgins",
    role: 'Periodista',
    period: '2021',
    link: 'https://www.tvn.cl',
    image: '/images/exp-tvn.png',
    alt: "TVN Red O'Higgins",
  },
  {
    organization: 'Diario La Tercera',
    role: 'Periodista',
    period: '2017 – 2020',
    link: 'https://www.latercera.com/',
    image: '/images/exp-la-tercera.png',
    alt: 'La Tercera',
  },
  {
    organization: 'Publimetro',
    role: 'Periodista',
    period: '2015 – 2017',
    link: 'https://www.publimetro.cl/',
    image: '/images/exp-publimetro.png',
    alt: 'Publimetro',
  },
  {
    organization: 'Servicio Agrícola y Ganadero (SAG) Región de Aysén',
    role: 'Encargado de Comunicaciones',
    period: '2013 – 2015',
    link: 'https://www.sag.gob.cl',
    image: '/images/exp-indap.png',
    alt: 'SAG Región de Aysén',
  },
  {
    organization: 'Radio Santa María de Coyhaique',
    role: 'Periodista',
    period: '2014 – 2015',
    link: 'https://www.radiosantamaria.cl/',
    image: '/images/exp-radio-santamaria.png',
    alt: 'Radio Santa María de Coyhaique',
  },
  {
    organization: 'Televisión Nacional de Chile',
    role: 'Periodista en práctica',
    period: '2013',
    link: 'https://www.tvn.cl',
    image: '/images/exp-tvn.png',
    alt: 'Televisión Nacional de Chile',
  },
];

const projects = [
  {
    id: 'operacion-topografo',
    title: 'Investigación periodística sobre espionaje militar',
    image: '/images/proyecto-topografo.jpg',
    alt: 'Operación Topógrafo',
    summary:
      'Operación Topógrafo reveló el espionaje ilegal de la Dirección de Inteligencia del Ejército de Chile a periodistas y funcionarios denunciantes. La publicación marcó un antes y un después en la discusión sobre transparencia y control civil de las Fuerzas Armadas, con repercusiones judiciales y mediáticas que se mantienen hasta hoy.',
    link: 'https://www.latercera.com/reportajes/noticia/operacion-topografo-espionaje-del-ejercito-cuatro-denunciantes-irregularidades/777342/',
  },
  {
    id: 'vocerias-y-despliegue',
    title: 'Vocerías y despliegue nacional',
    image: '/images/vocerias.jpg',
    alt: 'Vocerías y despliegue',
    summary:
      'He recorrido las 16 regiones del país, tanto en territorio continental como insular, asesorando a autoridades de distintos gobiernos. Me especializo en fortalecer las vocerías, orientar ante crisis y consolidar la coherencia comunicacional entre diferentes niveles.',
    link: '',
  },
  {
    id: 'comunicacion-digital',
    title: 'Comunicación digital adaptada al estilo de redes sociales',
    image: '/images/digital.jpg',
    alt: 'Comunicación digital',
    summary:
      'He reorientado las comunicaciones digitales institucionales desde un enfoque formal hacia un lenguaje adaptado al estilo propio de las redes sociales, capaz de visibilizar los logros de la administración y simultáneamente conectar con públicos diversos. La conducción hacia este enfoque permitió a la cuenta de INDAP aumentar en 81% el número total de seguidores en dos años.',
    link: '',
  },
];

const projectById = (id) => projects.find((project) => project.id === id);
const projectInvestigacion = projectById('operacion-topografo');
const projectVocerias = projectById('vocerias-y-despliegue');
const projectDigital = projectById('comunicacion-digital');

const formatReflectionParagraph = (value: string) =>
  value
    .replace(/^>\s*/, '')
    .replace(/\*\*(.+?)\*\*/g, '$1')
    .replace(/\*(.+?)\*/g, '$1')
    .replace(/`(.+?)`/g, '$1')
    .trim();

const reflectionEntries = await Astro.glob('./reflexiones/*.md');
const reflectionSummaries: Record<string, string> = {
  'la-ley-de-la-variedad-requerida':
    'La ley de la variedad requerida, postulada por Ross Ashby en 1958, es una de las piedras angulares de la cibernética y una lección vigente para afrontar el entorno comunicativo actual. Según el psiquiatra inglés, un sistema solo puede sobrevivir y mantenerse estable si su capacidad de respuestas al menos iguala la complejidad de las perturbaciones que provienen del entorno.',
  'comunicar-sin-miedo':
    'Durante una visita a Rapa Nui tuve la oportunidad de entrevistar a la alcaldesa Elizabeth Arévalo Pakarati. Terminada la conversación, mi reacción fue inmediata: ya quisiera cualquier político o directivo de empresa su capacidad de comunicar, le dije. Todo funcionó perfecto. Su vestimenta, postura, tono y locuacidad —del latín loquax, “el que tiene facilidad de palabra”— demostraban un trabajo constante y dedicado. Lejos de parecer una imagen artificial, solo irradiaba seguridad en sí misma.',
  'autoridades-y-redes-sociales':
    'Pese a lo que muchas autoridades creen, las redes sociales institucionales no son su canal de noticias 24/7 a su disposición. Registrar y publicar cada una de sus actividades públicas no solo distrae a los equipos de comunicaciones de lo realmente importante —gestión de prensa, comunicación interna o creación de contenido de valor—, sino que termina generando más bloqueos que los soñados “likes”.',
};

const reflexiones = reflectionEntries
  .map((entry) => {
    const slugFromUrl = entry.url?.split('/').filter(Boolean).pop();
    const slugFromFile = entry.file.substring(entry.file.lastIndexOf('/') + 1).replace(/\.md$/i, '');
    const slug = slugFromUrl ?? slugFromFile ?? `reflexion-${Math.random().toString(36).slice(2, 8)}`;

    const paragraphs = entry
      .rawContent()
      .split(/\r?\n\r?\n/)
      .map((paragraph) => paragraph.trim())
      .filter(Boolean)
      .map(formatReflectionParagraph);

    const summary = reflectionSummaries[slug] ?? paragraphs[0] ?? '';
    const content = [...paragraphs];

    const rawOrder = entry.frontmatter?.order;
    const order = typeof rawOrder === 'number' ? rawOrder : Number.NEGATIVE_INFINITY;

    return {
      id: slug,
      title: entry.frontmatter?.title ?? slug,
      summary,
      content,
      order,
    };
  })
  .sort((a, b) => b.order - a.order)
  .map(({ order, ...rest }) => rest);

const press = [
  {
    title: 'Operación Topógrafo — Espionaje del Ejército a denunciantes',
    outlet: 'La Tercera',
    link: 'https://www.latercera.com/reportajes/noticia/operacion-topografo-espionaje-del-ejercito-cuatro-denunciantes-irregularidades/777342/',
    image: '/images/topografo.jpg',
    alt: 'Operación Topógrafo — Espionaje del Ejército a denunciantes',
    summary: 'Investigación que reveló el espionaje del Ejército a periodistas y denunciantes.',
  },
  {
    title: 'Ricardo Lagos: “Durante mi gobierno no privaticé nada, al contrario”',
    outlet: 'Publimetro',
    link: 'https://www.publimetro.cl/cl/noticias/2016/11/18/ex-presidente-lagos-durante-mi-gobierno-no-privatice-nada-contrario.html',
    image: '/images/lagos.jpg',
    alt: 'Ricardo Lagos: “Durante mi gobierno no privaticé nada, al contrario”',
    summary: 'Entrevista al ex Presidente Ricardo Lagos sobre su legado económico y político.',
  },
  {
    title: 'Sebastián Piñera: “Me siento orgulloso de lo que he logrado en la vida”',
    outlet: 'Publimetro',
    link: 'https://www.publimetro.cl/cl/noticias/2017/06/19/sebastian-pinera-me-siento-orgulloso-lo-he-logrado-vida.html',
    image: '/images/pinera.jpg',
    alt: 'Sebastián Piñera: “Me siento orgulloso de lo que he logrado en la vida”',
    summary: 'Entrevista centrada en la trayectoria empresarial y política de Sebastián Piñera.',
  },
  {
    title: 'Hernán Larraín: “No somos partidarios de indultar a violadores de DD.HH. ni asesinos en serie”',
    outlet: 'La Tercera',
    link: 'https://www.latercera.com/nacional/noticia/hernan-larrain-ministro-justicia-derechos-humanos-no-somos-partidarios-indultar-violadores-dd-hh-asesinos-serie/111533/',
    image: '/images/larrain.jpg',
    alt: 'Hernán Larraín: “No somos partidarios de indultar a violadores de DD.HH. ni asesinos en serie”',
    summary: 'Entrevista sobre justicia transicional, derechos humanos y políticas del Ministerio de Justicia.',
  },
  {
    title: 'La declaración de ‘Ramiro’ ante Carroza',
    outlet: 'La Tercera',
    link: 'https://www.latercera.com/la-tercera-pm/noticia/la-declaracion-ramiro-carroza-estoy-seguro-estaba-privado-libertad-detencion-preventiva/792779/',
    image: '/images/ramiro.jpg',
    alt: 'La declaración de ‘Ramiro’ ante Carroza',
    summary: 'Cobertura al testimonio de Mauricio Hernández Norambuena (Ramiro) ante el ministro Carroza.',
  },
  {
    title: "El Papa en La Araucanía: 'Mari Mari, peñi, lamngen'",
    outlet: 'La Tercera',
    link: 'https://www.latercera.com/noticia/papa-la-araucania-mari-mari/',
    image: '/images/papa.jpg',
    alt: "El Papa en La Araucanía: 'Mari Mari, peñi, lamngen'",
    summary: 'Cobertura especial de la visita del Papa Francisco a La Araucanía.',
  },
  {
    title: 'Llaitul: líderes mapuches llaman a la resistencia en funeral de Catrillanca',
    outlet: 'La Tercera',
    link: 'https://www.latercera.com/nacional/noticia/llaitul-lideres-mapuches-llaman-resistencia-funeral-catrillanca/406714/',
    image: '/images/catrillanca.jpg',
    alt: 'Llaitul llama a la resistencia en funeral de Camilo Catrillanca',
    summary: 'Cobertura sobre el funeral de Camilo Catrillanca.',
  },
  {
    title: 'Habla el juez de Rancagua Marcelo Vásquez',
    outlet: 'La Tercera',
    link: 'https://www.latercera.com/reportajes/noticia/habla-el-juez-de-rancagua-marcelo-vasquez-siento-decepcion-de-haber-impartido-un-tipo-de-justicia-que-hoy-se-me-niega/747167/',
    image: '/images/vasquez.jpg',
    alt: 'Juez Marcelo Vásquez: "Siento decepción de haber impartido un tipo de justicia que hoy se me niega"',
    summary: 'Visión del juez Marcelo Vásquez sobre la crisis judicial en Rancagua.',
  },
  {
    title: 'Eduardo Frei: “He sido víctima de un gran fraude”',
    outlet: 'La Tercera',
    link: 'https://www.latercera.com/politica/noticia/eduardo-frei-he-victima-gran-fraude/823635/',
    image: '/images/frei.jpg',
    alt: 'Eduardo Frei sobre el fraude que lo afectó',
    summary: 'Crónica sobre conferencia de prensa de Eduardo Frei sobre la estafa que impactó a su familia.',
  },
  {
    title: 'La Parinacota: balas y abandono',
    outlet: 'La Tercera',
    link: 'https://www.latercera.com/nacional/noticia/la-parinacota-balas-abandono/614633/',
    image: '/images/parinacota.jpg',
    alt: 'Reportaje La Parinacota: entre las balas y el abandono',
    summary: 'Reportaje sobre el abandono y la violencia en la población ubicada en la comuna de Quilicura.',
  },
  {
    title: 'Los múltiples contratos del médico de la Presidenta Bachelet',
    outlet: 'Publimetro',
    link: 'https://www.publimetro.cl/cl/noticias/2016/12/13/multiples-contratos-medico-presidenta-bachelet.html',
    image: '/images/puccio.jpg',
    alt: 'Investigación sobre los contratos del médico de Bachelet',
    summary: 'Investigación periodística sobre los contratos del médico de la Presidenta Bachelet.',
  },
];
---
<Default title="Inicio">
  <Hero client:load />

  <section class="max-w-4xl mx-auto px-6 py-16">
    <div class="systems-quote">
      <p class="systems-quote-text font-heading tracking-[-0.02em]" data-systems-quote>
        <span class="systems-typewriter" data-systems-typewriter></span>
      </p>
      <p class="systems-quote-author">W. Ross Ashby</p>
    </div>
  </section>

  {projectVocerias && (
    <section class="project-feature py-16">
      <figure class="project-feature-media group">
        <img
          src={projectVocerias.image}
          alt={projectVocerias.alt ?? projectVocerias.title}
          loading="lazy"
          class="project-feature-image"
        />
        <figcaption class="project-feature-overlay project-feature-overlay--right">
          <div class="project-feature-content">
            <h3 class="project-feature-title">{projectVocerias.title}</h3>
            <p class="project-feature-summary">{projectVocerias.summary}</p>
          </div>
        </figcaption>
      </figure>
    </section>
  )}

  <section id="experiencia" class="max-w-6xl mx-auto px-6 py-16">
    <div class="flex flex-col gap-4 md:flex-row md:items-end md:justify-between">
      <div class="space-y-3">
        <p class="text-xs tracking-[0.35em] text-text-dim">Trayectoria</p>
        <h2 class="text-3xl font-heading tracking-[-0.02em] text-text-light">Roles clave al servicio de la comunicación pública</h2>
      </div>
    </div>
    <div class="mt-10 grid gap-6 md:grid-cols-2">
      {trajectory.map(({ organization, role, period, link, image, alt }, index) => (
        <div
          class={`group flex h-full flex-col gap-6 rounded-[2rem] border border-black/5 bg-gradient-to-br from-[#F8EFDD] via-[#F2E6D5] to-[#E9D7BE] p-8 shadow-[0_24px_48px_rgba(20,20,20,0.12)] transition hover:-translate-y-2 hover:shadow-[0_32px_64px_rgba(20,20,20,0.18)] ${index >= 6 ? 'trajectory-extra hidden' : ''}`}
          data-trajectory-extra={index >= 6 ? 'true' : undefined}
        >
          <div class="flex items-start gap-5">
            <div class="flex h-16 w-16 items-center justify-center rounded-2xl border border-black/10 bg-white shadow-[0_12px_24px_rgba(15,15,15,0.08)]">
              <img src={image} alt={alt} class="max-h-10 w-auto" loading="lazy" />
            </div>
            <div class="space-y-2">
              <p class="text-[0.65rem] font-semibold uppercase tracking-[0.35em] text-text-dim">{period}</p>
              <h3 class="text-xl font-heading tracking-[-0.015em] text-text-light">{role}</h3>
              <p class="text-sm text-text-dim">{organization}</p>
            </div>
          </div>
          
        </div>
      ))}
    </div>
    {trajectory.length > 6 && (
      <div class="mt-10 flex justify-center">
        <button id="trajectory-toggle" class="btn">Ver más</button>
      </div>
    )}
  </section>

  {projectDigital && (
    <section class="project-feature py-16">
      <figure class="project-feature-media group">
        <img
          src={projectDigital.image}
          alt={projectDigital.alt ?? projectDigital.title}
          loading="lazy"
          class="project-feature-image"
        />
        <figcaption class="project-feature-overlay">
          <div class="project-feature-content">
            <h3 class="project-feature-title">{projectDigital.title}</h3>
            <p class="project-feature-summary">{projectDigital.summary}</p>
          </div>
        </figcaption>
      </figure>
    </section>
  )}

  <section id="reflexiones" class="max-w-6xl mx-auto px-6 py-16">
    <h2 class="text-3xl font-heading mb-6">Opinión</h2>
    <div class="grid gap-16 md:grid-cols-3">
          {reflexiones.map(({ id, title, summary, content }, index) => (
        <div class="group flex h-full flex-col gap-5">
          <span class="reflection-top-line" aria-hidden="true" />
          <button
            type="button"
            class="min-h-[4.5rem] text-left text-2xl font-semibold tracking-[0.08em] text-text-light title-button"
            data-modal={`reflection-${id}`}
          >
            <span class="title-highlight-hover">{index === 0 ? 'El desafío comunicacional contemporáneo' : title}</span>
          </button>
          <p class="flex-1 text-sm leading-relaxed text-text-dim">{summary}</p>
          <button type="button" class="btn mt-auto self-start" data-modal={`reflection-${id}`}>
            Leer completa
          </button>
          <dialog id={`reflection-${id}`} class="app-modal reflection-modal">
            <form method="dialog" class="flex justify-end">
              <button class="btn">Cerrar</button>
            </form>
            <div class="reflection-modal-content">
              <span class="reflection-modal-ornament" aria-hidden="true" />
              <div class="space-y-4">
                <h3 class="text-2xl font-semibold text-text-light">{title}</h3>
                <p class="text-xs tracking-[0.3em] text-text-dim">Por S. Vedoya</p>
                {content.map((paragraph) => (
                  <p class="text-sm leading-relaxed text-text-dim">{paragraph}</p>
                ))}
              </div>
            </div>
          </dialog>
        </div>
      ))}
    </div>
  </section>

  {projectInvestigacion && (
    <section class="project-feature py-16">
      <figure class="project-feature-media group">
        <img
          src={projectInvestigacion.image}
          alt={projectInvestigacion.alt ?? projectInvestigacion.title}
          loading="lazy"
          class="project-feature-image"
        />
        <figcaption class="project-feature-overlay">
          <div class="project-feature-content">
            <h3 class="project-feature-title">{projectInvestigacion.title}</h3>
            <p class="project-feature-summary">{projectInvestigacion.summary}</p>
            {projectInvestigacion.link && (
              <div class="project-actions">
                <a
                  href={projectInvestigacion.link}
                  target="_blank"
                  rel="noopener"
                  class="btn"
                >
                  Ver reportaje
                </a>
              </div>
            )}
          </div>
        </figcaption>
      </figure>
    </section>
  )}

  <section id="prensa" class="max-w-6xl mx-auto px-6 py-16">
    <h2 class="text-3xl font-heading mb-6">Prensa</h2>
    <div class="grid gap-16 md:grid-cols-3">
      {press.map(({ title, outlet, link, summary, image, alt }, index) => (
        <div class={`press-entry group flex h-full flex-col gap-5 ${index >= 3 ? 'press-extra is-hidden' : ''}`} data-press-extra={index >= 3 ? 'true' : undefined}>
          <div class="press-media" aria-hidden="true">
            <img src={image} alt={alt} loading="lazy" />
          </div>
          <p class="press-outlet">{outlet}</p>
          <a
            href={link}
            target="_blank"
            rel="noopener"
            class="title-button text-left text-2xl font-semibold tracking-[0.08em] text-text-light"
          >
            <span class="title-highlight-hover">{title}</span>
          </a>
          <p class="flex-1 text-sm leading-relaxed text-text-dim">{summary}</p>
          <span class="press-divider" aria-hidden="true" />
        </div>
      ))}
    </div>
    <div class="mt-8 flex justify-center">
      <button id="press-toggle" class="btn">Ver más</button>
    </div>
  </section>

  <section id="contacto" class="contact-section px-6 py-20">
    <div class="contact-shell">
      <div class="flex flex-col items-center gap-8">
        <h2 class="contact-title font-heading text-center">¡Conversemos!</h2>
        <div class="flex flex-col gap-4 w-full max-w-xs">
          <a href="mailto:seba.vedoya@gmail.com" class="btn w-full text-center">Contáctame</a>
          <a href="/files/CV.pdf" class="btn w-full text-center">Descargar CV</a>
          <a href="https://www.linkedin.com/in/sebastianvedoyam/" target="_blank" rel="noopener" class="btn w-full text-center">LinkedIn</a>
        </div>
      </div>
    </div>
  </section>

  <script is:inline>
    const modalTriggers = document.querySelectorAll('[data-modal]');
    const modals = document.querySelectorAll('.app-modal');

    modalTriggers.forEach((trigger) => {
      trigger.addEventListener('click', () => {
        const id = trigger.getAttribute('data-modal');
        const dialog = id ? document.getElementById(id) : null;
        if (dialog instanceof HTMLDialogElement && typeof dialog.showModal === 'function') {
          dialog.showModal();
        }
      });
    });

    modals.forEach((dialog) => {
      dialog.addEventListener('click', (event) => {
        const rect = dialog.getBoundingClientRect();
        const outside =
          event.clientX < rect.left ||
          event.clientX > rect.right ||
          event.clientY < rect.top ||
          event.clientY > rect.bottom;

        if (outside) {
          dialog.close();
        }
      });

      dialog.addEventListener('cancel', (event) => {
        event.preventDefault();
        dialog.close();
      });
    });

    const quoteElement = document.querySelector('[data-systems-quote]');
    const typewriterElement = document.querySelector('[data-systems-typewriter]');
    const quoteText = '“Ningún actor puede controlar el entorno sin igualarlo en complejidad; y si no puede igualarlo, debe aprender a domesticarlo.”';

    if (quoteElement && typewriterElement) {
      let index = 0;
      const speed = 30;

      const type = () => {
        if (index <= quoteText.length) {
          typewriterElement.textContent = quoteText.slice(0, index);
          index += 1;
          window.setTimeout(type, speed);
        }
      };

      type();
    }

    const trajectoryToggle = document.getElementById('trajectory-toggle');
    const trajectoryExtras = document.querySelectorAll('[data-trajectory-extra="true"]');
    let trajectoryExpanded = false;

    if (trajectoryToggle && trajectoryExtras.length > 0) {
      trajectoryToggle.addEventListener('click', () => {
        trajectoryExpanded = !trajectoryExpanded;
        trajectoryExtras.forEach((card) => {
          card.classList.toggle('hidden', !trajectoryExpanded);
        });
        trajectoryToggle.textContent = trajectoryExpanded ? 'Ver menos' : 'Ver más';
      });
    }

    const pressToggle = document.getElementById('press-toggle');
    const pressCards = Array.from(document.querySelectorAll('[data-press-extra]'));
    let pressRevealed = 0;

    const updatePressVisibility = () => {
      pressCards.forEach((card, index) => {
        card.classList.toggle('is-hidden', index >= pressRevealed);
      });
    };

    updatePressVisibility();

    if (pressToggle) {
      pressToggle.addEventListener('click', () => {
        pressRevealed = Math.min(pressCards.length, pressRevealed + 3);
        updatePressVisibility();
        if (pressRevealed >= pressCards.length) {
          pressToggle.disabled = true;
          pressToggle.textContent = 'No hay más notas';
        }
      });
    }

    const reflectionToggles = document.querySelectorAll('.reflection-toggle');
    reflectionToggles.forEach((toggle) => {
      toggle.addEventListener('click', () => {
        const card = toggle.closest('.reflection-card');
        const details = card?.querySelector('.reflection-details');
        if (!card || !details) {
          return;
        }

        const isHidden = details.classList.toggle('hidden');
        toggle.textContent = isHidden ? 'Ver más' : 'Ver menos';
      });
    });
  </script>
</Default>
